<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Factura / Comprobante</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#f7faf7; }
    .invoice {
      max-width: 900px; margin: 24px auto; background:#fff; border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06); overflow: hidden;
      border:1px solid rgba(0,0,0,.06);
    }
    .invoice header {
      background: linear-gradient(135deg, #1d8223, #388E3C);
      color:#fff; padding: 18px 24px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .invoice .brand { font-weight:800; letter-spacing:.3px; }
    .invoice .badge-id {
      background: rgba(255,255,255,.2);
      padding:6px 10px; border-radius: 999px; font-weight:600;
    }
    .invoice .body { padding: 20px 24px; }
    .invoice .sec { margin-bottom: 18px; }
    .invoice .sec h6 { color:#1d8223; font-weight:800; margin-bottom:8px; }
    .invoice table thead th {
      background:#e9f5eb; border-top:1px solid #d7ead9; border-bottom:1px solid #d7ead9;
    }
    .totals .row > div { padding: 2px 0; }
    .totals .label { color:#555; }
    .totals .value { text-align: right; font-weight:600; }
    .footer-actions { padding: 14px 24px 20px; display:flex; gap:12px; }
    @media print {
      .no-print { display:none !important; }
      body { background:#fff; }
      .invoice { box-shadow:none; border:0; margin:0; max-width:100%; }
    }
  </style>
</head>
<body>
  <div class="invoice">
    <header>
      <div>
        <div class="brand h4 m-0">CUSCO STORE</div>
        <small>RUC 2016568956 — Cusco, Perú</small>
      </div>
      <div class="text-end">
        <div class="badge-id" id="f_id">—</div>
        <div><small id="f_fecha">—</small></div>
      </div>
    </header>

    <div class="body">
      <div class="row sec">
        <div class="col-md-6">
          <h6>Cliente</h6>
          <div><strong id="f_nombre">—</strong></div>
          <div id="f_email">—</div>
          <div id="f_telefono">—</div>
        </div>
        <div class="col-md-6">
          <h6>Entrega</h6>
          <div id="f_entrega">—</div>
          <h6 class="mt-3">Pago</h6>
          <div id="f_pago">—</div>
        </div>
      </div>

      <div class="sec">
        <h6>Detalle</h6>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Producto</th>
                <th class="text-center" style="width:100px">Cant.</th>
                <th class="text-end" style="width:140px">Precio</th>
                <th class="text-end" style="width:140px">Subtotal</th>
              </tr>
            </thead>
            <tbody id="f_items"></tbody>
          </table>
        </div>
      </div>

      <div class="sec totals">
        <div class="row">
          <div class="col-6 label">Subtotal</div><div class="col-6 value" id="f_sub">—</div>
          <div class="col-6 label">IGV (18%)</div><div class="col-6 value" id="f_igv">—</div>
          <div class="col-6 label">Envío</div><div class="col-6 value" id="f_env">—</div>
          <div class="col-6 label">Descuento</div><div class="col-6 value" id="f_desc">—</div>
        </div>
        <hr class="my-2">
        <div class="d-flex justify-content-between">
          <div class="h6 m-0">TOTAL</div>
          <div class="h5 m-0" id="f_total">—</div>
        </div>
      </div>
    </div>

    <div class="footer-actions no-print">
      <a href="index.html" class="btn btn-outline-secondary">Ir al inicio</a>
      <a href="tienda.html" class="btn btn-outline-secondary">Seguir comprando</a>
      <button id="btn_print" class="btn btn-success ms-auto">Imprimir</button>
    </div>
  </div>

  <script>
    const PEN = new Intl.NumberFormat("es-PE", { style:"currency", currency:"PEN" });

    function getQueryId() {
      const p = new URLSearchParams(location.search);
      return p.get("id") || localStorage.getItem("lastOrderId") || null;
    }

    function loadOrder() {
      const id = getQueryId();
      const orders = JSON.parse(localStorage.getItem("orders") || "[]");
      return orders.find(o => o.id === id) || null;
    }

    function fmtDate(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString("es-PE", { dateStyle: "medium", timeStyle: "short" });
      } catch { return "—"; }
    }

    function render() {
      const o = loadOrder();
      if (!o) { alert("No se encontró el pedido."); return; }

      // Header
      document.getElementById("f_id").textContent = o.id;
      document.getElementById("f_fecha").textContent = fmtDate(o.fechaISO);

      // Cliente
      document.getElementById("f_nombre").textContent = o.cliente?.nombre || "—";
      document.getElementById("f_email").textContent = o.cliente?.email || "—";
      document.getElementById("f_telefono").textContent = o.cliente?.telefono || "—";

      // Entrega y pago
      document.getElementById("f_entrega").textContent = o.entrega?.texto || (o.entrega?.tipo === "recojo" ? "Recojo en tienda" : "Delivery");
      document.getElementById("f_pago").textContent = o.pago?.etiqueta || "—";

      // Items
      const tbody = document.getElementById("f_items");
      tbody.innerHTML = "";
      (o.items || []).forEach(i => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <div class="d-flex align-items-center gap-2">
              <img src="${i.img}" alt="${i.nombre}" style="width:40px;height:40px;object-fit:contain;border:1px solid #eee;border-radius:8px;background:#fff;padding:4px">
              <div class="fw-semibold">${i.nombre}</div>
            </div>
          </td>
          <td class="text-center">${i.cantidad}</td>
          <td class="text-end">${PEN.format(i.precio)}</td>
          <td class="text-end">${PEN.format(i.subtotal)}</td>
        `;
        tbody.appendChild(tr);
      });

      // Totales
      const t = o.totales || {};
      document.getElementById("f_sub").textContent   = PEN.format(t.subtotal || 0);
      document.getElementById("f_igv").textContent   = PEN.format(t.igv || 0);
      document.getElementById("f_env").textContent   = PEN.format(t.envio || 0);
      document.getElementById("f_desc").textContent  = `- ${PEN.format(t.descuento || 0)}`;
      document.getElementById("f_total").textContent = PEN.format(t.total || 0);
    }

    document.addEventListener("DOMContentLoaded", () => {
      render();
      document.getElementById("btn_print")?.addEventListener("click", () => window.print());
    });
  </script>
</body>
</html>
